#include "global.h"
#include "uart.h"
#include "prt.h"
#include <string.h>
#include "esc2bmp.h"
#include "net.h"

esc2bmp_handle_t prt_handle;

unsigned char test_cmd[] = { 0x1b, 0x1b, 0x52, 0x45, 0x43, 0x45, 0x49, 0x56, 0x45, 0x0d, 0x0a, 0x55, 0x49, 0x44, 0x3a, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x38, 0x33, 0x33, 0x30, 0x30, 0x30, 0x32, 0x0d, 0x0a, 0x50, 0x49, 0x44, 0x3a, 0x5b, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x38, 0x33, 0x33, 0x30, 0x30, 0x30, 0x32, 0x5d, 0x0d, 0x0a, 0x6d, 0x6f, 0x64, 0x65, 0x6c, 0x5f, 0x69, 0x64, 0x78, 0x3a, 0x30, 0x30, 0x30, 0x31, 0x0d, 0x0a, 0x1b, 0x40, 0x1b, 0x70, 0x00, 0x32, 0x7d, 0x1d, 0x21, 0x00, 0x1b, 0x61, 0x01, 0x1b, 0x33, 0x1e, 0x1b, 0x61, 0x01, 0x49, 0x6e, 0x64, 0x6f, 0x63, 0x68, 0x61, 0x74, 0x0a, 0x0a, 0x1b, 0x61, 0x00, 0x44, 0x69, 0x6e, 0x65, 0x20, 0x49, 0x6e, 0x0a, 0x54, 0x61, 0x62, 0x6c, 0x65, 0x20, 0x74, 0x61, 0x62, 0x6c, 0x65, 0x31, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x47, 0x75, 0x65, 0x73, 0x74, 0x20, 0x31, 0x0a, 0x52, 0x65, 0x63, 0x65, 0x69, 0x70, 0x74, 0x20, 0x23, 0x20, 0x3a, 0x20, 0x32, 0x30, 0x30, 0x39, 0x30, 0x30, 0x30, 0x30, 0x30, 0x33, 0x0a, 0x44, 0x61, 0x74, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3a, 0x20, 0x32, 0x30, 0x32, 0x30, 0x2d, 0x30, 0x39, 0x2d, 0x30, 0x32, 0x20, 0x31, 0x36, 0x3a, 0x32, 0x34, 0x3a, 0x34, 0x31, 0x0a, 0x53, 0x74, 0x61, 0x66, 0x66, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3a, 0x20, 0x4d, 0x61, 0x6e, 0x61, 0x67, 0x65, 0x72, 0x0a, 0x1d, 0x21, 0x01, 0x1b, 0x61, 0x01, 0x43, 0x4f, 0x50, 0x59, 0x20, 0x52, 0x45, 0x43, 0x45, 0x49, 0x50, 0x54, 0x1d, 0x21, 0x00, 0x0a, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x0a, 0x1b, 0x33, 0x1e, 0x1b, 0x61, 0x00, 0x33, 0x20, 0x78, 0x20, 0x35, 0x30, 0x2c, 0x30, 0x30, 0x30, 0x0a, 0x6b, 0x6f, 0x70, 0x69, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x31, 0x35, 0x30, 0x2c, 0x30, 0x30, 0x30, 0x0a, 0x0a, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x3d, 0x0a, 0x1b, 0x33, 0x1e, 0x53, 0x55, 0x42, 0x54, 0x4f, 0x54, 0x41, 0x4c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x31, 0x35, 0x30, 0x2e, 0x30, 0x30, 0x30, 0x0a, 0x53, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x20, 0x43, 0x68, 0x61, 0x72, 0x67, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x0a, 0x54, 0x41, 0x58, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x31, 0x35, 0x2e, 0x30, 0x30, 0x30, 0x0a, 0x52, 0x6f, 0x75, 0x6e, 0x64, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x0a, 0x1d, 0x21, 0x01, 0x54, 0x4f, 0x54, 0x41, 0x4c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x31, 0x36, 0x35, 0x2e, 0x30, 0x30, 0x30, 0x0a, 0x1d, 0x21, 0x00, 0x50, 0x61, 0x79, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x28, 0x43, 0x61, 0x73, 0x68, 0x29, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x31, 0x36, 0x35, 0x2e, 0x30, 0x30, 0x30, 0x0a, 0x43, 0x68, 0x61, 0x6e, 0x67, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x0a, 0x1b, 0x61, 0x01, 0x1b, 0x61, 0x01, 0x0a, 0x54, 0x68, 0x61, 0x6e, 0x6b, 0x20, 0x79, 0x6f, 0x75, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x79, 0x6f, 0x75, 0x72, 0x20, 0x76, 0x69, 0x73, 0x69, 0x74, 0x0a, 0x0a, 0x1b, 0x61, 0x01, 0x50, 0x6f, 0x77, 0x65, 0x72, 0x65, 0x64, 0x20, 0x62, 0x79, 0x20, 0x77, 0x77, 0x77, 0x2e, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x62, 0x69, 0x6c, 0x6c, 0x2e, 0x69, 0x64, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x1b, 0x69, 0x1b, 0x1b, 0x52, 0x45, 0x43, 0x45, 0x4e, 0x44, 0x0d, 0x0a};
unsigned char prt_data[] = {0x1B, 0x40, 0x1B, 0x70, 0x00, 0x32, 0x7D, 0x1D, 0x21, 0x00, 0x1B, 0x61, 0x01, 0x1B, 0x33, 0x1E, 0x1B, 0x61, 0x01, 0x49, 0x6E, 0x64, 0x6F, 0x63, 0x68, 0x61, 0x74, 0x0A, 0x0A, 0x1B, 0x61, 0x00, 0x54, 0x61, 0x6B, 0x65, 0x20, 0x41, 0x77, 0x61, 0x79, 0x0A, 0x52, 0x65, 0x63, 0x65, 0x69, 0x70, 0x74, 0x20, 0x23, 0x20, 0x3A, 0x20, 0x32, 0x30, 0x31, 0x31, 0x30, 0x30, 0x30, 0x33, 0x35, 0x39, 0x0A, 0x44, 0x61, 0x74, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3A, 0x20, 0x32, 0x30, 0x32, 0x30, 0x2D, 0x31, 0x32, 0x2D, 0x30, 0x33, 0x20, 0x31, 0x31, 0x3A, 0x30, 0x32, 0x3A, 0x30, 0x33, 0x0A, 0x53, 0x74, 0x61, 0x66, 0x66, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3A, 0x20, 0x4D, 0x61, 0x6E, 0x61, 0x67, 0x65, 0x72, 0x0A, 0x1D, 0x21, 0x01, 0x1B, 0x61, 0x01, 0x43, 0x4F, 0x50, 0x59, 0x20, 0x52, 0x45, 0x43, 0x45, 0x49, 0x50, 0x54, 0x1D, 0x21, 0x00, 0x0A, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x0A, 0x1B, 0x33, 0x1E, 0x1B, 0x61, 0x00, 0x31, 0x20, 0x78, 0x20, 0x35, 0x2C, 0x30, 0x30, 0x30, 0x0A, 0x46, 0x6F, 0x6F, 0x64, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x35, 0x2C, 0x30, 0x30, 0x30, 0x0A, 0x0A, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x3D, 0x0A, 0x1B, 0x33, 0x1E, 0x53, 0x55, 0x42, 0x54, 0x4F, 0x54, 0x41, 0x4C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x35, 0x2E, 0x30, 0x30, 0x30, 0x0A, 0x53, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x20, 0x43, 0x68, 0x61, 0x72, 0x67, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x0A, 0x54, 0x41, 0x58, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x35, 0x30, 0x30, 0x0A, 0x52, 0x6F, 0x75, 0x6E, 0x64, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x0A, 0x1D, 0x21, 0x01, 0x54, 0x4F, 0x54, 0x41, 0x4C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x35, 0x2E, 0x35, 0x30, 0x30, 0x0A, 0x1D, 0x21, 0x00, 0x50, 0x61, 0x79, 0x6D, 0x65, 0x6E, 0x74, 0x20, 0x28, 0x43, 0x61, 0x73, 0x68, 0x29, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x35, 0x30, 0x2E, 0x30, 0x30, 0x30, 0x0A, 0x43, 0x68, 0x61, 0x6E, 0x67, 0x65, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x34, 0x34, 0x2E, 0x35, 0x30, 0x30, 0x0A, 0x1B, 0x61, 0x01, 0x1B, 0x61, 0x01, 0x0A, 0x54, 0x68, 0x61, 0x6E, 0x6B, 0x20, 0x79, 0x6F, 0x75, 0x20, 0x66, 0x6F, 0x72, 0x20, 0x79, 0x6F, 0x75, 0x72, 0x20, 0x76, 0x69, 0x73, 0x69, 0x74, 0x0A, 0x0A, 0x1B, 0x61, 0x01, 0x50, 0x6F, 0x77, 0x65, 0x72, 0x65, 0x64, 0x20, 0x62, 0x79, 0x20, 0x77, 0x77, 0x77, 0x2E, 0x68, 0x65, 0x6C, 0x6C, 0x6F, 0x62, 0x69, 0x6C, 0x6C, 0x2E, 0x69, 0x64, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x1B, 0x69};




unsigned int usb_data_cb(void *buff, unsigned int size)
{
	printf("usb %d bytes %.*s\n", size, size, buff);
}
void bmp_cb(const char *bmp_path)
{
    printf("function %s was called\n", __FUNCTION__);
	printf("bmp_path = %s\n", bmp_path);
	// if (prt_handle.bmp_print) {
	// 	printf("start print bmp!\n");
	// 	prt_handle.bmp_print(bmp_path);
	// 	prt_handle.printer_cut(8);
	// }

    system("rm ./escode/upload.zip");
    system("zip -r ./escode/upload.zip ./escode/*");
    g_upload_flag = 1;
}

void prt_init (void)
{

    unsigned char test_feed[3] = {0x1b, 0x64, 0x06};
    unsigned char test_cut[4] = {0x1d, 0x56, 0x42, 0x40};
    char *prt_str = "INIT OK!\n";
    printf ("prt_init \n");
    char bmp_path[] = "/smart9/escode/100000000018330045_100000000018330045_0017.bmp";
    memset(&prt_handle, 0, sizeof(prt_handle));

    prt_handle.bmp_callback = bmp_cb;
	prt_handle.usb_data_cb = usb_data_cb;
    //strcpy(prt_handle.bmp_path, bmp_path);
	esc2bmp_version_print();
    printf("start init!\n");
    if (esc2bmp_init(&prt_handle)) {
		printf("Initial failed!!!\n");
		exit(1);
	}
    printf("init success!\n");

    //prt_handle.esc_2_prt(prt_str, 10);
    //prt_handle.printer_cut(96);
    // while(1)
    // {
    //     prt_handle.esc_2_prt(prt_data, sizeof(prt_data));
    //     sleep(10);
    // }


}

void prt_print (unsigned char* data, int len)
{
   printf ("start prt_print! \n");
   uart_write (data, len);
}

int escpos_printer_feed( const int lines)
{


    char buffer[3];
    strncpy(buffer, ESCPOS_CMD_FEED, 2);
    buffer[2] = lines;
    uart_write (buffer, sizeof(buffer));
    return 0;
}

int escpos_printer_cut(const int lines)
{
    char buffer[4];
    strncpy(buffer, ESCPOS_CMD_CUT, 3);
    buffer[3] = lines;
    uart_write (buffer, sizeof(buffer));
    return 0;
}


extern void lib_event_callback(hprt_lib_event_t e, const void *arg, unsigned int size)
{
    volatile static unsigned char re_prt_flag = 0;
    unsigned char tmp_data = 0;
    printf("callback id = %d, size = %d, data is:\n", e, size);
    //print_array(arg, size);
    switch(e)
    {
        case HPRT_LIB_EVENT_STATUS:
            tmp_data = *(unsigned char *)arg;
            if(((tmp_data >> 2) & 0x01) == 0x01)
            {
                printf("prt open!\n");
                re_prt_flag = 1;
            }
            if(((tmp_data >> 2) & 0x01) == 0x00)
            {
                printf("prt close!\n");
                prt_handle.esc_2_prt(pn_data.data, pn_data.len);
                prt_handle.printer_cut(84);
                prt_handle.push_process_id(0x01);
                re_prt_flag = 0;
            }
        break;

        case HPRT_LIB_EVENT_ID_RET:
            // memset(pn_data.data, 0x00, pn_data.len);
            // pn_data.len = 0;
        break;


    }
}

void get_offline_code(void)
{
    int32_t len;
    load_data("./prt.bin", &pn_data.data[pn_data.len], &len);
    pn_data.len += (len - 2);
}





